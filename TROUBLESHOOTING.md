# üö® Claude Code Config - Troubleshooting Completo

**Gu√≠a definitiva para resolver CUALQUIER problema del sistema de sincronizaci√≥n v4.0**

## üìã √çndice de Problemas

- [üî¥ CR√çTICO - Sistema No Funciona](#-cr√≠tico---sistema-no-funciona)
- [üü° ADVERTENCIA - Funciona Parcialmente](#-advertencia---funciona-parcialmente)  
- [üü¢ INFORMACI√ìN - Dudas de Funcionamiento](#-informaci√≥n---dudas-de-funcionamiento)
- [üîß Comandos de Diagn√≥stico](#-comandos-de-diagn√≥stico)
- [üÜò Recovery Total](#-recovery-total)

---

## üî¥ CR√çTICO - Sistema No Funciona

### ‚ùå **"sudo: a password is required"**

**CAUSA:** Systemd requiere privilegios root para instalar servicios

**SOLUCI√ìN:**
```bash
# Ejecutar con sudo (es obligatorio)
sudo python3 install.py

# Si no tienes sudo, a√±√°dete al grupo sudo:
su -
usermod -aG sudo $(whoami)
exit
# Re-login y prueba de nuevo
```

**VERIFICAR:**
```bash
sudo -v  # Debe pedir password y aceptarlo
```

---

### ‚ùå **"systemctl: command not found"**

**CAUSA:** Sistema sin systemd (containers/WSL1 antiguos)

**SOLUCI√ìN WSL2:**
```bash
# Instalar systemd
sudo apt update && sudo apt install systemd

# Habilitar systemd en WSL2
echo -e "[boot]\nsystemd=true" | sudo tee -a /etc/wsl.conf

# Reiniciar WSL
wsl --shutdown
# Reabrir terminal WSL
```

**SOLUCI√ìN CONTAINERS:**
```bash
# Usar solo modo daemon (sin systemd)
python3 install.py  # Solo restore
nohup python3 install.py --daemon > logs/daemon.log 2>&1 &
```

**VERIFICAR:**
```bash
systemctl --version  # Debe mostrar versi√≥n
```

---

### ‚ùå **"git push failed" / "Permission denied"**

**CAUSA:** Git no configurado o sin permisos GitHub

**SOLUCI√ìN CONFIGURACI√ìN:**
```bash
# Verificar configuraci√≥n actual
git config --get user.name
git config --get user.email
git remote -v

# Configurar si est√° vac√≠o
git config --global user.name "Tu Nombre Real"
git config --global user.email "tu@email.com"

# Verificar remote correcto
git remote set-url origin https://github.com/tuusuario/claude-code-config.git
```

**SOLUCI√ìN AUTENTICACI√ìN:**
```bash
# Opci√≥n 1: Personal Access Token (recomendado)
git remote set-url origin https://TOKEN@github.com/usuario/repo.git

# Opci√≥n 2: SSH Key
ssh-keygen -t ed25519 -C "tu@email.com"
cat ~/.ssh/id_ed25519.pub  # A√±adir a GitHub Settings > SSH Keys
git remote set-url origin git@github.com:usuario/repo.git

# Opci√≥n 3: GitHub CLI
gh auth login
```

**VERIFICAR:**
```bash
git push origin main  # Debe funcionar sin errores
```

---

### ‚ùå **"Service failed to start"**

**CAUSA:** Error en systemd service o permisos

**DIAGN√ìSTICO COMPLETO:**
```bash
# Ver error espec√≠fico
sudo journalctl -u claude-sync.service --no-pager | tail -20

# Ver status detallado  
sudo systemctl status claude-sync.service -l

# Verificar archivo de servicio
cat /etc/systemd/system/claude-sync.service

# Verificar permisos
ls -la ~/.claude/
ls -la claude_config/
```

**SOLUCI√ìN:**
```bash
# Detener y limpiar servicio
sudo systemctl stop claude-sync.service
sudo systemctl disable claude-sync.service
sudo rm -f /etc/systemd/system/claude-sync.service
sudo systemctl daemon-reload

# Reinstalar completamente
sudo python3 install.py

# Verificar
sudo systemctl status claude-sync.service
```

---

### ‚ùå **"OSError: Unknown error -25"**

**CAUSA:** Error de detecci√≥n usuario en entornos especiales

**SOLUCI√ìN YA INCLUIDA EN v4.0:**
```python
# El script ya maneja este error autom√°ticamente
CURRENT_USER = os.getenv('USER', 'unknown')
```

**SI PERSISTE:**
```bash
# Verificar variables de entorno
echo $USER
echo $HOME
whoami

# Ejecutar con variables expl√≠citas
USER=$(whoami) HOME=$HOME python3 install.py
```

---

## üü° ADVERTENCIA - Funciona Parcialmente

### ‚ö†Ô∏è **"Sync funciona pero no hace push"**

**CAUSA:** Problemas de conectividad o permisos git

**DIAGN√ìSTICO:**
```bash
# Ver logs de sync
tail -f logs/sync.log | grep -E "(ERROR|FAILED|‚ùå)"

# Test conectividad
ping github.com
curl -I https://github.com

# Test git manual
cd /ruta/a/claude-code-config
git status
git add .
git commit -m "test"
git push origin main
```

**SOLUCI√ìN:**
```bash
# Si git funciona manual pero no autom√°tico:
sudo systemctl restart claude-sync.service

# Ver logs en tiempo real
sudo journalctl -u claude-sync.service -f
```

---

### ‚ö†Ô∏è **"Servicio activo pero no sincroniza"**

**CAUSA:** Archivos no cambian o ruta incorrecta

**DIAGN√ìSTICO:**
```bash
# Verificar que daemon est√° corriendo
sudo systemctl status claude-sync.service

# Ver logs daemon
tail -f logs/sync.log

# Verificar rutas
python3 -c "
from pathlib import Path
print('CLAUDE_DIR:', Path.home() / '.claude')
print('CONFIG_DIR:', Path.cwd() / 'claude_config')
print('Exists ~/.claude:', (Path.home() / '.claude').exists())
print('Exists config:', (Path.cwd() / 'claude_config').exists())
"

# Test manual de cambios
touch ~/.claude/test_file
sleep 70  # Esperar m√°s de 1 minuto
git status  # Debe mostrar cambios
```

---

### ‚ö†Ô∏è **"JSON validation failed"**

**CAUSA:** Archivo .claude.json corrupto

**DIAGN√ìSTICO:**
```bash
# Verificar JSON
python3 -c "
import json
try:
    with open('claude_config/.claude.json') as f:
        data = json.load(f)
    print('‚úÖ JSON v√°lido')
    print('Claves:', list(data.keys()))
except Exception as e:
    print(f'‚ùå JSON inv√°lido: {e}')
"

# Verificar tambi√©n el archivo usuario
python3 -c "
import json
from pathlib import Path
claude_json = Path.home() / '.claude.json'
if claude_json.exists():
    try:
        with open(claude_json) as f:
            data = json.load(f)
        print('‚úÖ ~/.claude.json v√°lido')
    except Exception as e:
        print(f'‚ùå ~/.claude.json inv√°lido: {e}')
else:
    print('‚ö†Ô∏è ~/.claude.json no existe')
"
```

**SOLUCI√ìN:**
```bash
# Restaurar desde backup
if [ -f ~/.claude.json.backup ]; then
    cp ~/.claude.json.backup ~/.claude.json
    echo "‚úÖ Restaurado desde backup"
fi

# O regenerar limpio
mv ~/.claude.json ~/.claude.json.broken
sudo python3 install.py  # Recrear√° el archivo
```

---

## üü¢ INFORMACI√ìN - Dudas de Funcionamiento

### ‚ùì **"¬øC√≥mo s√© si est√° funcionando?"**

**VERIFICACI√ìN COMPLETA:**
```bash
# 1. Estado del servicio
sudo systemctl status claude-sync.service
# Debe mostrar: active (running)

# 2. Ver logs en tiempo real
tail -f logs/sync.log
# Debe mostrar ciclos cada 60s

# 3. Test de sync funcional
echo "test-$(date)" > ~/.claude/test-sync.txt
sleep 70  # Esperar m√°s de 1 minuto
git log --oneline -1  # Debe mostrar commit reciente
ls claude_config/  # Debe contener test-sync.txt

# 4. Test de push
git log --oneline -5
# Debe mostrar commits "auto-sync" recientes
```

---

### ‚ùì **"¬øQu√© archivos sincroniza exactamente?"**

**ARCHIVOS SINCRONIZADOS:**
```bash
# Ver archivos que se monitorizan
python3 -c "
from pathlib import Path

claude_dir = Path.home() / '.claude'
config_files = ['settings.json', 'CLAUDE.md', 'CLAUDE_CODE_REFERENCE.md']
config_dirs = ['commands', 'agents']

print('üìÑ ARCHIVOS:')
for f in config_files:
    path = claude_dir / f
    status = '‚úÖ' if path.exists() else '‚ùå'
    print(f'  {status} ~/.claude/{f}')

print('\nüìÅ DIRECTORIOS:')
for d in config_dirs:
    path = claude_dir / d
    status = '‚úÖ' if path.exists() else '‚ùå'
    print(f'  {status} ~/.claude/{d}/')

print('\nüîß ESPECIALES:')
claude_json = Path.home() / '.claude.json'
status = '‚úÖ' if claude_json.exists() else '‚ùå'
print(f'  {status} ~/.claude.json (solo mcpServers)')
"
```

---

### ‚ùì **"¬øC√≥mo cambio la frecuencia de sync?"**

**CAMBIAR INTERVALO:**
```bash
# Editar constante en install.py
sed -i 's/SYNC_INTERVAL = 60/SYNC_INTERVAL = 300/' install.py  # 5 minutos
# O editar manualmente l√≠nea 18: SYNC_INTERVAL = 300

# Reinstalar servicio
sudo python3 install.py

# Verificar cambio
grep "SYNC_INTERVAL" install.py
sudo journalctl -u claude-sync.service -f  # Ver nuevo intervalo
```

---

## üîß Comandos de Diagn√≥stico

### **üîç Diagn√≥stico Completo del Sistema**

```bash
#!/bin/bash
# SUPER DIAGN√ìSTICO - Copia y ejecuta todo

echo "üîç === DIAGN√ìSTICO CLAUDE CODE CONFIG v4.0 ==="
echo "üìÖ $(date)"
echo

echo "üìä ESTADO DEL SISTEMA:"
echo "‚Ä¢ Usuario actual: $(whoami)"
echo "‚Ä¢ Directorio trabajo: $(pwd)"
echo "‚Ä¢ Python version: $(python3 --version)"
echo "‚Ä¢ Git version: $(git --version)"
echo

echo "üõ°Ô∏è ESTADO SYSTEMD:"
if command -v systemctl >/dev/null 2>&1; then
    echo "‚Ä¢ Systemctl: ‚úÖ Disponible"
    sudo systemctl status claude-sync.service --no-pager | head -10
else
    echo "‚Ä¢ Systemctl: ‚ùå No disponible"
fi
echo

echo "üìÅ ESTRUCTURA ARCHIVOS:"
echo "‚Ä¢ install.py: $([ -f install.py ] && echo '‚úÖ' || echo '‚ùå')"
echo "‚Ä¢ claude_config/: $([ -d claude_config ] && echo '‚úÖ' || echo '‚ùå')"  
echo "‚Ä¢ logs/: $([ -d logs ] && echo '‚úÖ' || echo '‚ùå')"
echo "‚Ä¢ ~/.claude/: $([ -d ~/.claude ] && echo '‚úÖ' || echo '‚ùå')"
echo "‚Ä¢ ~/.claude.json: $([ -f ~/.claude.json ] && echo '‚úÖ' || echo '‚ùå')"
echo

echo "üîß CONFIGURACI√ìN GIT:"
echo "‚Ä¢ user.name: $(git config --get user.name || echo 'NO CONFIGURADO')"
echo "‚Ä¢ user.email: $(git config --get user.email || echo 'NO CONFIGURADO')"
echo "‚Ä¢ remote: $(git remote get-url origin 2>/dev/null || echo 'NO CONFIGURADO')"
echo

echo "üìä √öLTIMOS LOGS:"
if [ -f logs/sync.log ]; then
    echo "‚Ä¢ sync.log (√∫ltimas 5 l√≠neas):"
    tail -5 logs/sync.log | sed 's/^/    /'
else
    echo "‚Ä¢ sync.log: ‚ùå No existe"
fi
echo

echo "üîç √öLTIMOS COMMITS:"
git log --oneline -5 | sed 's/^/    /'
echo

echo "üåê CONECTIVIDAD:"
if ping -c 1 github.com >/dev/null 2>&1; then
    echo "‚Ä¢ GitHub: ‚úÖ Conectado"
else
    echo "‚Ä¢ GitHub: ‚ùå Sin conexi√≥n"
fi

echo
echo "üéØ RESUMEN:"
if systemctl is-active --quiet claude-sync.service 2>/dev/null; then
    echo "‚Ä¢ Servicio: ‚úÖ ACTIVO"
else
    echo "‚Ä¢ Servicio: ‚ùå INACTIVO"
fi

if [ -f ~/.claude/settings.json ] && [ -f claude_config/settings.json ]; then
    echo "‚Ä¢ Archivos: ‚úÖ SINCRONIZADOS"
else
    echo "‚Ä¢ Archivos: ‚ùå DESINCRONIZADOS" 
fi

if git diff-index --quiet HEAD -- 2>/dev/null; then
    echo "‚Ä¢ Git: ‚úÖ LIMPIO"
else
    echo "‚Ä¢ Git: ‚ö†Ô∏è CAMBIOS PENDIENTES"
fi

echo
echo "üÜò SI HAY PROBLEMAS:"
echo "1. sudo python3 install.py  # Reinstalar"
echo "2. sudo journalctl -u claude-sync.service -f  # Ver logs"
echo "3. tail -f logs/sync.log  # Ver sync detallado"
```

### **üö® Test de Funcionalidad End-to-End**

```bash
#!/bin/bash
# TEST E2E - Verifica todo el flujo

echo "üß™ === TEST END-TO-END CLAUDE CODE CONFIG ==="
echo

# 1. Crear archivo test
test_file="test-e2e-$(date +%s).txt"
echo "Testing sync at $(date)" > ~/.claude/$test_file
echo "‚úÖ 1. Archivo test creado: ~/.claude/$test_file"

# 2. Esperar 2 ciclos de sync (130 segundos)
echo "‚è≥ 2. Esperando 2 minutos y 10 segundos para sync..."
for i in {130..1}; do
    printf "\r   Restando: %d segundos " $i
    sleep 1
done
printf "\n"

# 3. Verificar sync local
if [ -f "claude_config/$test_file" ]; then
    echo "‚úÖ 3. Archivo sincronizado localmente"
else
    echo "‚ùå 3. FALLO: Archivo NO sincronizado localmente"
fi

# 4. Verificar commit
if git log --oneline -1 | grep -q "auto-sync"; then
    echo "‚úÖ 4. Commit autom√°tico realizado"
else
    echo "‚ùå 4. FALLO: No hay commit autom√°tico"
fi

# 5. Verificar push remoto
if git status | grep -q "up to date"; then
    echo "‚úÖ 5. Push remoto exitoso"
else
    echo "‚ö†Ô∏è 5. ADVERTENCIA: Push puede estar pendiente"
fi

# 6. Cleanup
rm -f ~/.claude/$test_file claude_config/$test_file
git add . && git commit -m "cleanup test e2e" && git push
echo "‚úÖ 6. Limpieza completada"

echo
echo "üéØ RESULTADO:"
echo "Si todos los pasos muestran ‚úÖ, el sistema funciona perfectamente."
```

---

## üÜò Recovery Total

### **üî• RESET COMPLETO - √öltima Opci√≥n**

**CUANDO TODO FALLA:**
```bash
#!/bin/bash
# RESET NUCLEAR - Solo usar si todo est√° roto

echo "üî• === RESET NUCLEAR CLAUDE CODE CONFIG ==="
read -p "‚ö†Ô∏è Esto BORRAR√Å todo y empezar√° desde cero. ¬øContinuar? [y/N]: " -n 1 -r
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Cancelado"
    exit 1
fi
echo

# 1. Backup de seguridad
echo "üíæ 1. Creando backup de emergencia..."
mkdir -p ~/backup-claude-emergency-$(date +%Y%m%d)
cp -r ~/.claude ~/backup-claude-emergency-$(date +%Y%m%d)/ 2>/dev/null || true
cp ~/.claude.json ~/backup-claude-emergency-$(date +%Y%m%d)/ 2>/dev/null || true
echo "‚úÖ Backup en ~/backup-claude-emergency-$(date +%Y%m%d)/"

# 2. Detener y eliminar servicio
echo "üõë 2. Eliminando servicio systemd..."
sudo systemctl stop claude-sync.service 2>/dev/null || true
sudo systemctl disable claude-sync.service 2>/dev/null || true  
sudo rm -f /etc/systemd/system/claude-sync.service
sudo systemctl daemon-reload
echo "‚úÖ Servicio eliminado"

# 3. Limpiar archivos locales
echo "üßπ 3. Limpiando archivos..."
rm -rf logs/
mkdir -p logs
echo "‚úÖ Logs reiniciados"

# 4. Reset git
echo "üîÑ 4. Reiniciando git..."
git reset --hard HEAD~10  # Volver 10 commits atr√°s
git clean -fd
echo "‚úÖ Git reiniciado"

# 5. Reinstalaci√≥n completa
echo "üöÄ 5. Reinstalaci√≥n completa..."
sudo python3 install.py
echo "‚úÖ Sistema reinstalado"

# 6. Verificaci√≥n
echo "üîç 6. Verificando instalaci√≥n..."
sleep 5
if systemctl is-active --quiet claude-sync.service; then
    echo "‚úÖ Servicio activo"
else
    echo "‚ùå FALLO: Servicio no activo"
fi

echo
echo "üéØ RESET COMPLETADO"
echo "üìÅ Backup en: ~/backup-claude-emergency-$(date +%Y%m%d)/"
echo "üîß Monitor: tail -f logs/sync.log"
echo "üìä Status: sudo systemctl status claude-sync.service"
```

### **üìã Checklist Post-Recovery**

```bash
# EJECUTAR DESPU√âS DEL RESET:

# ‚úÖ 1. Verificar servicio
sudo systemctl status claude-sync.service

# ‚úÖ 2. Ver logs primeros minutos  
tail -f logs/sync.log

# ‚úÖ 3. Test funcionalidad
echo "recovery-test-$(date)" > ~/.claude/recovery-test.txt
sleep 70
ls claude_config/recovery-test.txt  # Debe existir

# ‚úÖ 4. Verificar push
git log --oneline -3

# ‚úÖ 5. Configurar git si necesario
git config --global user.name "Tu Nombre"
git config --global user.email "tu@email.com"

# ‚úÖ 6. Test final
python3 -c "print('üéØ Recovery completado - Sistema operativo')"
```

---

## üìû **CONTACTO DE EMERGENCIA**

Si nada de esta gu√≠a funciona:

1. **Copia TODO el output** del diagn√≥stico completo
2. **Incluye logs espec√≠ficos** del error
3. **Especifica tu entorno** (WSL1/WSL2, Ubuntu version, etc.)
4. **Describe qu√© intentaste** antes del problema

**‚ö†Ô∏è IMPORTANTE:** Nunca borres los backups autom√°ticos (archivos `.backup`) hasta confirmar que todo funciona.

---

**ü§ñ v4.0 Enterprise Troubleshooting Guide**  
*Para cualquier problema, hay una soluci√≥n documentada.*